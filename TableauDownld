import requests
import pandas as pd
import io

# Tableau Server details
TABLEAU_SERVER = "https://your-tableau-server.com"
USERNAME = "your_username"
PASSWORD = "your_password"
SITE_ID = ""  # Keep empty for default site
VIEW_NAME = "YourViewName/TabName"  # Get this from the Tableau URL
OUTPUT_FILE = "tableau_data.csv"  # Optional if saving locally

# Step 1: Authenticate and Get Session Token
auth_url = f"{TABLEAU_SERVER}/api/3.10/auth/signin"
auth_payload = {
    "credentials": {
        "name": USERNAME,
        "password": PASSWORD,
        "site": {"contentUrl": SITE_ID}
    }
}

session = requests.Session()
auth_response = session.post(auth_url, json=auth_payload)
auth_response.raise_for_status()

token = auth_response.json()["credentials"]["token"]
headers = {"X-Tableau-Auth": token}

# Step 2: Construct URL for Downloading CSV
csv_url = f"{TABLEAU_SERVER}/views/{VIEW_NAME}/csv"

# Step 3: Download CSV data
response = session.get(csv_url, headers=headers)

if response.status_code == 200:
    # Load data into a Pandas DataFrame
    df = pd.read_csv(io.StringIO(response.text))
    print("Tableau data downloaded successfully!")
    
    # Optionally save as CSV
    df.to_csv(OUTPUT_FILE, index=False)
    print(f"Data saved to {OUTPUT_FILE}")

    # Display DataFrame
    import ace_tools as tools
    tools.display_dataframe_to_user(name="Tableau Report Data", dataframe=df)

else:
    print("Failed to download data:", response.status_code, response.text)

# Step 4: Sign Out
session.post(f"{TABLEAU_SERVER}/api/3.10/auth/signout", headers=headers)
