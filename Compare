import PyPDF2
import difflib
import openpyxl
from openpyxl.styles import Font, PatternFill

# Function to extract text from a PDF file by page
def extract_text_from_pdf(file_path):
    with open(file_path, "rb") as file:
        reader = PyPDF2.PdfReader(file)
        text_by_page = []
        for page_num, page in enumerate(reader.pages):
            text = page.extract_text()
            text_by_page.append((page_num + 1, text))  # Store page number with text
        return text_by_page

# Paths to the PDF files
file_a_path = "C8.pdf"
file_b_path = "C5.pdf"

# Excel Workbook Setup
workbook = openpyxl.Workbook()
sheet = workbook.active
sheet.title = "PDF Differences"

# Set up headers
headers = ["Page Number", "Line Numbers", "File 1 Content", "File 2 Content"]
sheet.append(headers)
header_font = Font(bold=True, color="FFFFFF")
header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
for col in range(1, len(headers) + 1):
    sheet.cell(row=1, column=col).font = header_font
    sheet.cell(row=1, column=col).fill = header_fill

try:
    # Extract text by page from both PDFs
    pdf_a_pages = extract_text_from_pdf(file_a_path)
    pdf_b_pages = extract_text_from_pdf(file_b_path)

    # Compare each page and log differences
    for (page_a_num, text_a), (page_b_num, text_b) in zip(pdf_a_pages, pdf_b_pages):
        # Use difflib to compare text on this page
        diff = list(difflib.ndiff(text_a.splitlines(), text_b.splitlines()))
        line_number = 1
        for line in diff:
            if line.startswith("- "):  # Removed from File 1
                removed_line = line[2:]
                added_line = next(
                    (l[2:] for l in diff if l.startswith("+ ")), ""
                )  # Match with added line if exists
                sheet.append([page_a_num, line_number, removed_line, added_line])
            elif line.startswith("+ "):  # Added in File 2
                added_line = line[2:]
                sheet.append([page_a_num, line_number, "", added_line])
            line_number += 1

    # Save the Excel file
    excel_file = "PDF_Differences.xlsx"
    workbook.save(excel_file)
    print(f"Differences saved to {excel_file}")

except FileNotFoundError as e:
    print(f"Error: {e}")
except Exception as e:
    print(f"An unexpected error occurred: {e}")
