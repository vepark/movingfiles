# Define parameters
param (
    [string]$BasePath = "Y:\DMS",
    [string]$DestinationPath = "C:\Users\Downloads",
    [string]$IDList = ""  # List of mainfolder_subfolder combinations
)

# Function to log messages
function Log-Message {
    param (
        [string]$msg
    )
    Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $msg"
}

# Function to copy subfolders to destination
function Copy-Subfolder {
    param (
        [string]$SourcePath,
        [string]$DestPath
    )
    Copy-Item -Path $SourcePath\* -Destination $DestPath -Recurse -Force
}

# Ensure the destination path exists
if (-not (Test-Path -Path $DestinationPath)) {
    New-Item -ItemType Directory -Path $DestinationPath | Out-Null
}

# Loop through each ID in the IDList
foreach ($ID in $IDList -split ',') {
    $ID = $ID.Trim()
    $IDs = $ID -split '_'
    $MainFolder = $IDs[0]
    $SubFolder = $IDs[1]

    $MainFolderPath = Join-Path -Path $BasePath -ChildPath $MainFolder
    $SubFolderPattern = $SubFolder

    if (Test-Path -Path $MainFolderPath) {
        $SubFolderPath = Get-ChildItem -Path $MainFolderPath -Recurse -Directory | Where-Object { $_.Name -eq $SubFolderPattern }

        if ($SubFolderPath) {
            # Construct the destination path including the main folder
            $DestSubPath = Join-Path -Path $DestinationPath -ChildPath "$MainFolder\$SubFolderPattern"
            if (-not (Test-Path -Path $DestSubPath)) {
                # Create the main folder at the destination first
                $DestMainFolderPath = Join-Path -Path $DestinationPath -ChildPath $MainFolder
                if (-not (Test-Path -Path $DestMainFolderPath)) {
                    New-Item -ItemType Directory -Path $DestMainFolderPath | Out-Null
                }

                # Create the subfolder within the newly created main folder
                New-Item -ItemType Directory -Path $DestSubPath | Out-Null
            }

            # Copy all contents of the subfolder directly into the destination subfolder
            Copy-Subfolder -SourcePath $SubFolderPath.FullName -DestPath $DestSubPath
            Log-Message "Copied $SubFolderPath to $DestSubPath"
        } else {
            Log-Message "Subfolder not found: $SubFolder in $MainFolderPath"
        }
    } else {
        Log-Message "Main folder path does not exist: $MainFolderPath"
    }
}

Log-Message "Script completed."
