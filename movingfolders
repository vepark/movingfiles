
# Define parameters
param (
    [string]$BasePath = "Y:\Ehhh",
    [string]$DestinationPath = "C:\Users\Downloads",
    [string]$IDList = "123456789_1234, 123456789_5678"  # List of mainfolder_subfolder combinations
)

# Function to log messages
function Log-Message {
    param (
        [string]$msg
    )
    Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $msg"
}

# Function to copy subfolders to destination
function Copy-Subfolder {
    param (
        [string]$SourcePath,
        [string]$DestPath
    )
    Copy-Item -Path $SourcePath\* -Destination $DestPath -Recurse -Force
}

# Ensure the destination path exists
if (-not (Test-Path -Path $DestinationPath)) {
    New-Item -ItemType Directory -Path $DestinationPath | Out-Null
}

# Initialize a hashtable to track created main folders in the destination
$CreatedMainFolders = @{}

# Loop through each ID in the IDList
foreach ($ID in $IDList -split ',') {
    $ID = $ID.Trim()
    $IDs = $ID -split '_'
    $MainFolder = $IDs[0]
    $SubFolderPattern = $IDs[1]

    $MainFolderPath = Join-Path -Path $BasePath -ChildPath $MainFolder

    if (Test-Path -Path $MainFolderPath) {
        # Find subfolders that contain the 4-digit pattern in their name
        $SubFolders = Get-ChildItem -Path $MainFolderPath -Directory | Where-Object { $_.Name -match "\b$SubFolderPattern\b" }

        if ($SubFolders.Count -gt 0) {
            # Ensure the destination main folder exists
            if (-not $CreatedMainFolders.ContainsKey($MainFolder)) {
                $DestMainFolderPath = Join-Path -Path $DestinationPath -ChildPath $MainFolder
                if (-not (Test-Path -Path $DestMainFolderPath)) {
                    New-Item -ItemType Directory -Path $DestMainFolderPath | Out-Null
                }
                $CreatedMainFolders[$MainFolder] = $DestMainFolderPath
            }

            # Copy each matching subfolder to the destination main folder
            foreach ($SubFolder in $SubFolders) {
                $DestSubPath = Join-Path -Path $CreatedMainFolders[$MainFolder] -ChildPath $SubFolder.Name
                if (-not (Test-Path -Path $DestSubPath)) {
                    New-Item -ItemType Directory -Path $DestSubPath | Out-Null
                }
                Copy-Subfolder -SourcePath $SubFolder.FullName -DestPath $DestSubPath
                Log-Message "Copied $SubFolder.FullName to $DestSubPath"
            }
        } else {
            Log-Message "No matching subfolders found in $MainFolderPath for pattern $SubFolderPattern"
        }
    } else {
        Log-Message "Main folder path does not exist: $MainFolderPath"
    }
}

Log-Message "Script completed."

