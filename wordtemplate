import pandas as pd
from docx import Document
import os

# === Update these paths ===
excel_path = "Updated_DPG_Auto_sample_data_for_template1.xlsx"
template_path = "Updated_AWB_sample_research_template2.docx"
output_dir = "generated_docs"
os.makedirs(output_dir, exist_ok=True)

# === Mapping: Word label -> Excel column ===
label_to_column = {
    "Case ID:": "CaseID",
    "Case Owner:": "CaseOwner",
    "Customer (Complainant) Name:": "CustomerName",
    "Customer Number (ECN):": "ECN",
    "Original Note Summary:": "OriginalNote",
    "Updated Note Summary:": "UpdatedNote",
    "Response Bulleted List:": "ResponseBulletList",
    "<<RelatedCasesRecontact>>": "RelatedCasesRecontact",
    "<<CrossLineBusinessCase>>": "CrossLineBusinessCase",
    "<<CallReviews>>": "CallReviews",
    "<<RiskIndicators>>": "RiskIndicators",
    "<<WF_TPError>>": "WF_TPError",
    "<<ReliefType>>": "ReliefType",
    "<<Resolution>>": "Resolution",
    "Enter reason for relief:": "Relief_Reason",
    "Note Resolution:": "Resolution_Note",
    ("Primary Complaint", "Enter Customer Problem and Description"): "Primary_Description",
    ("Primary Complaint", "List details from the complaint"): "Primary_Details",
    ("Primary Complaint", "Cite documents, tools, systems"): "Primary_Citations",
    ("Primary Complaint", "Summarize findings of the research"): "Primary_Summary",
    ("Secondary Complaint", "Enter Customer Problem and Description"): "Secondary_Description",
    ("Secondary Complaint", "List details from the complaint"): "Secondary_Details",
    ("Secondary Complaint", "Cite documents, tools, systems"): "Secondary_Citations",
    ("Secondary Complaint", "Summarize findings of the research"): "Secondary_Summary",
    ("Additional Complaint(s)", "Enter Customer Problem and Description"): "Additional_Description",
    ("Additional Complaint(s)", "List details from the complaint"): "Additional_Details",
    ("Additional Complaint(s)", "Cite documents, tools, systems"): "Additional_Citations",
    ("Additional Complaint(s)", "Summarize findings of the research"): "Additional_Summary"
}

# === Fill table values (section aware) ===
def fill_table(table, label_to_value):
    section = table.rows[0].cells[0].text.strip()
    for row in table.rows:
        for i, cell in enumerate(row.cells[:-1]):
            label = cell.text.strip()
            key = (section, label) if (section, label) in label_to_value else label
            if key in label_to_value:
                row.cells[i+1].text = str(label_to_value[key])

# === Replace all <<placeholders>> in text ===
def replace_placeholders(doc, label_to_value):
    def replace(text):
        for key, val in label_to_value.items():
            if isinstance(key, str) and key.startswith("<<") and key.endswith(">>"):
                text = text.replace(key, str(val))
        return text

    for para in doc.paragraphs:
        for run in para.runs:
            run.text = replace(run.text)
    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for para in cell.paragraphs:
                    for run in para.runs:
                        run.text = replace(run.text)

# === Generate one file per case ===
df = pd.read_excel(excel_path, dtype={"CaseID": str})
for idx, row in df.iterrows():
    doc = Document(template_path)
    label_to_value = {
        key: str(row[col]).strip() if pd.notnull(row[col]) else ""
        for key, col in label_to_column.items()
    }
    for table in doc.tables:
        fill_table(table, label_to_value)
    replace_placeholders(doc, label_to_value)
    case_id = str(row["CaseID"]).zfill(16)
    doc.save(os.path.join(output_dir, f"Case_{case_id}.docx"))

print("All case documents created successfully.")
