import pandas as pd
from docx import Document
import os

# Load Excel data
df = pd.read_excel("/home/_data.xlsx", dtype={"CaseID": str})

# Template and output path
template_path = "/home/u_template1.docx"
output_dir = "/home/output/"
os.makedirs(output_dir, exist_ok=True)

# Label-to-column mapping
label_to_column = {
    "Case ID:": "CaseID",
    "Case Owner:": "CaseOwner",
    "Customer (Complainant) Name:": "CustomerName",
    "Customer Number (ECN):": "ECN",
    "Original Note Summary:": "OriginalNote",
    "Updated Note Summary:": "UpdatedNote",
    "Response Bullet List:": "ResponseBulletList",

    # Placeholders like <<RelatedCasesRecontact>> etc
    "<<RelatedCasesRecontact>>": "RelatedCasesRecontact",
    "<<CrossLineBusinessCase>>": "CrossLineBusinessCase",
    "<<CallReviews>>": "CallReviews",
    "<<RiskIndicators>>": "RiskIndicators",
    "<<WF_TPError>>": "WF_TPError",
    "<<ReliefType>>": "ReliefType",
    "<<Relief_Reason>>": "Relief_Reason",
    "<<Resolution>>": "Resolution_Note"
}

# Function to fill table cell to the right of label
def fill_table_right_cell(table, label_to_value):
    try:
        section_title = table.rows[0].cells[0].text.strip()
    except:
        section_title = ""

    for row in table.rows:
        for i, cell in enumerate(row.cells):
            cell_text = cell.text.strip()
            for label, value in label_to_value.items():
                if cell_text.startswith(label):
                    if i + 1 < len(row.cells):
                        row.cells[i + 1].text = str(value)
                    break

# Replace placeholders inside any paragraph/table/run
def replace_placeholders(doc, label_to_value):
    def replace_text(text):
        for label, val in label_to_value.items():
            if label.startswith("<<") and label.endswith(">>"):
                text = text.replace(label, str(val))
        return text

    for para in doc.paragraphs:
        for run in para.runs:
            run.text = replace_text(run.text)

    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for para in cell.paragraphs:
                    for run in para.runs:
                        run.text = replace_text(run.text)

# Main loop
for idx, row in df.iterrows():
    doc = Document(template_path)

    label_to_value = {
        key: str(row[val]).strip() if pd.notnull(row[val]) else ""
        for key, val in label_to_column.items()
    }

    for table in doc.tables:
        fill_table_right_cell(table, label_to_value)

    replace_placeholders(doc, label_to_value)

    case_id = str(row["CaseID"]).zfill(16)
    output_path = os.path.join(output_dir, f"Case_{case_id}.docx")
    doc.save(output_path)
    print(f"[Saved] {output_path}")

print("All done!")
